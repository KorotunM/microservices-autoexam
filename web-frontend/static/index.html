<!doctype html>
<html lang="ru">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Учёт финансов</title>
  <link rel="icon" href="./static/favicon.ico" type="image/x-icon">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      font-family: "Montserrat", "Segoe UI", sans-serif;
      color: #0f172a;
      background: #f8fafc;
    }

    body {
      margin: 0;
    }

    header {
      background: linear-gradient(135deg, #0f172a, #1d4ed8);
      color: #fff;
      padding: 24px 32px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
      max-width: 1440px;
      align-self: center;
      margin: 0 auto;
      border-bottom-left-radius: 32px;
      border-bottom-right-radius: 32px;
    }

    a {
      color: #fff;
      text-decoration: none;
      font-weight: 600;
      margin-left: 12px;
    }

    .container {
      max-width: 960px;
      margin: 60px auto;
      padding: 0 16px 48px;
    }

    .card {
      background: #fff;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 10px 30px rgba(15, 23, 42, 0.08);
      margin-bottom: 16px;
    }

    .tabs {
      display: flex;
      gap: 10px;
      margin-top: 8px;
      justify-content: center;
    }

    .btn {
      display: inline-block;
      padding: 10px 16px;
      border-radius: 8px;
      background: #1d4ed8;
      color: #fff;
      border: none;
      cursor: pointer;
      font-weight: 600;
    }

    .btn.secondary {
      background: #1d4ed8;
    }

    input,
    select {
      width: 95%;
      padding: 10px 12px;
      margin: 6px 0 12px;
      border-radius: 8px;
      border: 1px solid #cbd5e1;
      background: #f8fafc;
    }

    .select {
      width: 100%;
    }

    label {
      font-weight: 600;
      font-size: 14px;
    }

    .grid {
      display: grid;
      gap: 16px;
    }

    .grid.two {
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
    }

    .status {
      padding: 10px 12px;
      border-radius: 8px;
      margin-bottom: 8px;
    }

    .status.info {
      background: #e0f2fe;
      color: #075985;
    }

    .status.error {
      background: #fee2e2;
      color: #991b1b;
    }

    .card-title {
      text-align: center;
      margin-top: 40px;
    }

    .card-text {
      text-align: center;
    }

    .card-home {
      align-items: center;
      min-height: 200px;
      width: fit-content;
      margin: 0 auto;
    }
  </style>
</head>

<body>
  <header>
    <div>
      <strong id="welcomeText" style="align-self: center;"></strong>
    </div>
    <div id="auth-status"></div>
  </header>

  <div class="container">
    <div id="status" class="status info" style="display:none"></div>

    <section id="page-home" class="card card-home">
      <h2 class="card-title">Учёт финансов</h2>
      <p class="card-text">Оптимизируй расходы и увеличь доходы.</p>
      <div class="tabs">
        <button class="btn" onclick="navigate('/login')">Войти</button>
        <button class="btn secondary" onclick="navigate('/register')">Регистрация</button>
      </div>
    </section>

    <section id="page-login" class="card card-home" style="display:none">
      <h2 id="loginTitle">Вход</h2>
      <label>Имя пользователя</label>
      <input id="login-username" placeholder="username">
      <label>Пароль</label>
      <input id="login-password" type="password" placeholder="пароль">
      <button class="btn" onclick="doLogin()">Войти</button>
    </section>

    <section id="page-register" class="card card-home" style="display:none">
      <h2 id="registerTitle">Регистрация</h2>
      <label>Имя пользователя</label>
      <input id="reg-username" placeholder="username">
      <label>Пароль</label>
      <input id="reg-password" type="password" placeholder="пароль (мин. 6)">
      <button class="btn" onclick="doRegister()">Создать аккаунт</button>
    </section>

    <section id="page-dashboard" style="display:none">
      <div class="grid two">
        <div class="card">
          <h3>Профиль</h3>
          <p><strong>Пользователь:</strong> <span id="profile-username">—</span></p>
        </div>
        <div class="card">
          <h3>Сводка</h3>
          <p><strong>Доходы:</strong> <span id="sum-income">0</span></p>
          <p><strong>Расходы:</strong> <span id="sum-expense">0</span></p>
          <p><strong>Баланс:</strong> <span id="sum-balance">0</span></p>
        </div>
      </div>

      <div class="card">
        <h3>Добавить операцию</h3>
        <div class="grid two">
          <div>
            <label>Тип</label>
            <select id="tx-type">
              <option value="income">Доход</option>
              <option value="expense">Расход</option>
            </select>
          </div>
          <div>
            <label>Категория</label>
            <input id="tx-category" placeholder="Категория">
          </div>
          <div>
            <label>Сумма</label>
            <input id="tx-amount" type="number" step="0.01" placeholder="0.00">
          </div>
          <div>
            <label>Дата операции</label>
            <input id="tx-date" type="datetime-local">
          </div>
        </div>
        <button class="btn" onclick="createTransaction()">Сохранить</button>
      </div>

      <div class="card">
        <h3>Накопительные суммы (30 дней)</h3>
        <canvas id="chart-days" height="120"></canvas>
      </div>

      <div class="card">
        <h3>Расходы по категориям</h3>
        <div style="max-width:480px;margin:auto;">
          <canvas id="chart-categories" height="200"></canvas>
        </div>
        <p id="chart-categories-empty" style="display:none; text-align:center;">Недостаточно данных для построения
          диаграммы</p>
      </div>
    </section>
  </div>

  <script>
    const TOKEN_KEY = "autoexam_token";

    function getToken() { return localStorage.getItem(TOKEN_KEY); }
    function setToken(token) { localStorage.setItem(TOKEN_KEY, token); }
    function clearToken() { localStorage.removeItem(TOKEN_KEY); }

    function resetClientState() {
      const ids = ["login-username", "login-password", "reg-username", "reg-password", "tx-category", "tx-amount", "tx-date"];
      ids.forEach(id => { const el = document.getElementById(id); if (el) el.value = ""; });
      const typeEl = document.getElementById("tx-type"); if (typeEl) typeEl.value = "income";
      document.getElementById("profile-username").textContent = "—";
      document.getElementById("sum-income").textContent = "0";
      document.getElementById("sum-expense").textContent = "0";
      document.getElementById("sum-balance").textContent = "0";
      if (window.chartDaysRef) { window.chartDaysRef.destroy(); window.chartDaysRef = null; }
      if (window.chartCatRef) { window.chartCatRef.destroy(); window.chartCatRef = null; }
      const ctxLine = document.getElementById("chart-days").getContext("2d");
      window.chartDaysRef = new Chart(ctxLine, { type: "line", data: { labels: [], datasets: [] }, options: { responsive: true } });
      const pie = document.getElementById("chart-categories");
      if (pie) pie.style.display = "none";
      const empty = document.getElementById("chart-categories-empty");
      if (empty) { empty.style.display = "block"; empty.textContent = "Недостаточно данных для построения диаграммы"; }
    }

    function navigate(path) {
      window.location.hash = path;
      renderRoute();
      renderAuthStatus();
    }

    function showStatus(msg, type = "info") {
      const el = document.getElementById("status");
      el.textContent = msg;
      el.className = `status ${type}`;
      el.style.display = "block";
      if (type === "info") {
        setTimeout(() => { el.style.display = "none"; }, 4000);
      }
    }

    function renderAuthStatus() {
      const container = document.getElementById("auth-status");
      const token = getToken();
      if (token) {
        container.innerHTML = '<a href="#" onclick="logout(); return false;">Выход</a>';
      } else {
        container.textContent = "Вы пока не вошли в аккаунт";
      }
    }

    async function apiFetch(url, options = {}) {
      const token = getToken();
      options.headers = options.headers || {};
      if (token) options.headers["Authorization"] = `Bearer ${token}`;
      options.headers["Content-Type"] = options.headers["Content-Type"] || "application/json";
      const resp = await fetch(url, options);
      let data = null;
      try { data = await resp.json(); } catch (e) { data = null; }
      if (!resp.ok) {
        let detail = `${resp.status} ${resp.statusText}`;
        if (data && data.detail) {
          if (Array.isArray(data.detail)) {
            detail = data.detail.map(d => {
              const loc = d.loc ? d.loc.join('.') : '';
              const msg = d.msg || d.message || '';
              return `${loc}: ${msg}`.trim();
            }).join('; ');
          } else if (typeof data.detail === 'string') {
            detail = data.detail;
          } else if (typeof data.detail === 'object') {
            detail = JSON.stringify(data.detail);
          }
        }
        throw new Error(detail);
      }
      return data;
    }

    async function doLogin() {
      const username = document.getElementById("login-username").value.trim();
      const password = document.getElementById("login-password").value.trim();
      try {
        const data = await apiFetch("/api/auth/login", {
          method: "POST",
          body: JSON.stringify({ username, password })
        });
        clearToken();
        resetClientState();
        setToken(data.access_token);
        renderAuthStatus();
        showStatus("Вход выполнен, переходим в кабинет");
        navigate("/dashboard");
        await loadDashboard();
      } catch (err) {
        showStatus("Ошибка входа: " + err.message, "error");
      }
    }

    async function doRegister() {
      const username = document.getElementById("reg-username").value.trim();
      const password = document.getElementById("reg-password").value.trim();
      try {
        await apiFetch("/api/auth/register", {
          method: "POST",
          body: JSON.stringify({ username, password })
        });
        showStatus("Регистрация успешна, выполните вход");
        navigate("/login");
      } catch (err) {
        showStatus("Ошибка регистрации: " + err.message, "error");
      }
    }

    async function refreshProfile() {
      try {
        const data = await apiFetch("/api/profile/me");
        document.getElementById("profile-username").textContent = data.username || "—";
      } catch (err) {
        showStatus("Ошибка профиля: " + err.message, "error");
      }
    }

    async function refreshSummary() {
      try {
        const data = await apiFetch("/api/finance/stats/summary");
        document.getElementById("sum-income").textContent = data.total_income;
        document.getElementById("sum-expense").textContent = data.total_expense;
        document.getElementById("sum-balance").textContent = data.balance;
      } catch (err) {
        showStatus("Ошибка сводки: " + err.message, "error");
      }
    }

    async function refreshChart() {
      try {
        const data = await apiFetch("/api/finance/stats/by-day?days=30");
        const items = (data.items || []).slice().sort((a, b) => new Date(a.date) - new Date(b.date));
        const labels = items.map(i => new Date(i.date).toLocaleDateString());
        let cumIncome = 0, cumExpense = 0;
        const incomes = [], expenses = [];
        for (const i of items) {
          cumIncome += parseFloat(i.income || 0);
          cumExpense += parseFloat(i.expense || 0);
          incomes.push(cumIncome);
          expenses.push(cumExpense);
        }
        renderLineChart(labels, incomes, expenses);
      } catch (err) {
        showStatus("Ошибка графика: " + err.message, "error");
      }

      try {
        const tx = await apiFetch("/api/finance/transactions");
        const expenseByCat = {};
        (tx.items || []).forEach(t => {
          if (t.type === 'expense') {
            const cat = t.category || 'без категории';
            expenseByCat[cat] = (expenseByCat[cat] || 0) + parseFloat(t.amount || 0);
          }
        });
        const labelsCat = Object.keys(expenseByCat);
        if (labelsCat.length === 0) {
          document.getElementById("chart-categories").style.display = "none";
          document.getElementById("chart-categories-empty").style.display = "block";
        } else {
          document.getElementById("chart-categories").style.display = "block";
          document.getElementById("chart-categories-empty").style.display = "none";
          renderPieChart(labelsCat, Object.values(expenseByCat));
        }
      } catch (err) {
        document.getElementById("chart-categories").style.display = "none";
        const empty = document.getElementById("chart-categories-empty");
        empty.style.display = "block";
        empty.textContent = "Недостаточно данных для построения диаграммы";
        console.warn("pie chart error", err);
      }
    }

    async function createTransaction() {
      const payload = {
        type: document.getElementById("tx-type").value,
        amount: document.getElementById("tx-amount").value,
        category: document.getElementById("tx-category").value || "general",
        occurred_at: document.getElementById("tx-date").value
          ? new Date(document.getElementById("tx-date").value).toISOString()
          : new Date().toISOString()
      };
      try {
        await apiFetch("/api/finance/transactions", {
          method: "POST",
          body: JSON.stringify(payload)
        });
        showStatus("Операция добавлена");
        await refreshSummary();
        await refreshChart();
      } catch (err) {
        showStatus("Ошибка добавления: " + err.message, "error");
      }
    }

    function logout() {
      clearToken();
      resetClientState();
      renderAuthStatus();
      showStatus("Вы вышли из аккаунта");
      navigate("/");
    }

    function renderLineChart(labels, incomes, expenses) {
      const ctx = document.getElementById("chart-days").getContext("2d");
      if (window.chartDaysRef) { window.chartDaysRef.destroy(); }
      window.chartDaysRef = new Chart(ctx, {
        type: "line",
        data: {
          labels,
          datasets: [
            { label: "Накопленные доходы", data: incomes, borderColor: "#22c55e", fill: false },
            { label: "Накопленные расходы", data: expenses, borderColor: "#ef4444", fill: false }
          ]
        },
        options: { responsive: true, tension: 0.2 }
      });
    }

    function renderPieChart(labels, data) {
      const ctx = document.getElementById("chart-categories").getContext("2d");
      if (window.chartCatRef) { window.chartCatRef.destroy(); }
      window.chartCatRef = new Chart(ctx, {
        type: "pie",
        data: {
          labels,
          datasets: [{ data, backgroundColor: ["#f87171", "#fb923c", "#fbbf24", "#34d399", "#60a5fa", "#a78bfa", "#f472b6"] }]
        },
        options: { responsive: true }
      });
    }

    function renderRoute() {
      const hash = window.location.hash.replace("#", "") || "/";
      document.querySelectorAll("section[id^='page-']").forEach(el => el.style.display = "none");
      if (hash.startsWith("/login")) {
        document.getElementById("page-login").style.display = "block";
      } else if (hash.startsWith("/register")) {
        document.getElementById("page-register").style.display = "block";
      } else if (hash.startsWith("/dashboard")) {
        document.getElementById("page-dashboard").style.display = "block";
        loadDashboard();
      } else {
        document.getElementById("page-home").style.display = "block";
      }
    }

    async function loadDashboard() {
      if (!getToken()) {
        showStatus("Нужно войти", "error");
        navigate("/login");
        return;
      }
      try {
        await refreshProfile();
      } catch (err) {
        const msg = err && err.message ? String(err.message) : "";
        if (msg.includes("401") || msg.includes("403")) {
          showStatus("Сессия истекла, войдите снова", "error");
          logout();
          return;
        }
        showStatus("Не удалось загрузить профиль: " + msg, "error");
      }
      try {
        await refreshSummary();
      } catch (err) {
        const msg = err && err.message ? String(err.message) : "";
        if (msg.includes("401") || msg.includes("403")) {
          showStatus("Сессия истекла, войдите снова", "error");
          logout();
          return;
        }
        showStatus("Не удалось загрузить сводку: " + msg, "error");
      }
      try {
        await refreshChart();
      } catch (err) {
        const msg = err && err.message ? String(err.message) : "";
        if (msg.includes("401") || msg.includes("403")) {
          showStatus("Сессия истекла, войдите снова", "error");
          logout();
          return;
        }
        showStatus("Не удалось загрузить графики: " + msg, "error");
      }
    }

    async function loadUiTexts() {
      try {
        const cfg = await fetch("/ui-config.json").then(r => r.json());
        document.getElementById("loginTitle").textContent = cfg.login_title;
        document.getElementById("registerTitle").textContent = cfg.register_title;
        document.getElementById("welcomeText").textContent = cfg.welcome_message;
      } catch (err) {
        console.warn("Не удалось загрузить ui-config:", err);
      }
    }

    window.addEventListener("hashchange", () => { renderRoute(); renderAuthStatus(); });
    window.addEventListener("DOMContentLoaded", () => {
      loadUiTexts();
      renderRoute();
      renderAuthStatus();
    });
  </script>
</body>

</html>